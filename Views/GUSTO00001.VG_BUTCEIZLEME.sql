SET QUOTED_IDENTIFIER, ANSI_NULLS OFF
GO
Create View [GUSTO00001].[VG_BUTCEIZLEME] As  select	distinct butcehareket.pButce pButce, nbutceyili nYil, ldbutcetutari,ldrevizetutar, (ldbutcetutari+ldrevizetutar) ldtoplambutcetutari, isnull(G.Tutar,0) ldgerceklesen, case when ldbutcetutari+ldrevizetutar>0 then (100*(isnull(G.Tutar,0)/(ldbutcetutari+ldrevizetutar))) else 0 end as ldgerceklesmeyuzdesi, ldbutcetutari+ldrevizetutar-isnull(G.Tutar,0) ldkalan, ldbloketutar, ldbutcetutari+ldrevizetutar-isnull(G.Tutar,0)-ldbloketutar ldkullbutcetutari  from GUSTO00001.butcehareket  inner join GUSTO00001.butcekodu on butcehareket.pbutce=butcekodu.butcekodu_rowid  inner join( select shd.pbutce, year(sh.dtTarih)nYil, sum(sh.ldFAIskontoSonrasiTutar) Tutar  from GUSTO00001.stokhareket sh  inner join GUSTO00001.stokhareketdetay shd on sh.stokhareket_rowid=shd.pstokhareket  inner join GUSTO00001.butcekodu bk on bk.ButceKodu_rowid=shd.pButce  group by pbutce, year(sh.dttarih)  union all  select pbutcekodu, year(ggh.dtHareketTarihi)nYil, sum(case cgelirgidersekli when '1' then ldgelirgidertutari else -ldgelirgidertutari end) tutar  from GUSTO00001.gelirgiderhareketi ggh  inner join GUSTO00001.butcekodu bk on bk.ButceKodu_rowid=ggh.pButceKodu  group by pbutcekodu, year(ggh.dtHareketTarihi)  ) G on G.pbutce=ButceHareket.pButce and G.nYil=butcehareket.nbutceyili  where butcehareket.pbutce=butcekodu.butcekodu_rowid
GO