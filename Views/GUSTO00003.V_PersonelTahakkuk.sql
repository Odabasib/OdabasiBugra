SET QUOTED_IDENTIFIER, ANSI_NULLS OFF
GO
create view [GUSTO00003].[V_PersonelTahakkuk] as select nYil , nAy , pPersonel,pIsYeri,pTahakkukTanimi,max(ldGunlukUcret) ldGunlukUcret,max(UcretTipi) UcretTipi,max(ldPrsKartiAylikUcret) ldPrsKartiAylikUcret,sum(GV_AylikMatrah) GV_AylikMatrah,sum(GV_AGI) GV_AGI, max(GV_AGIOrani) GV_AGIOrani,min (BirikenGVMatrahi) BirikenGVMatrahi,sum(Issizlik_IsciHissesi) Issizlik_IsciHissesi,sum(Issizlik_Matrah) Issizlik_Matrah, sum(Issizlik_IsverenHissesi) Issizlik_IsverenHissesi,sum(Issizlik_DevletPayi) Issizlik_DevletPayi ,sum(ldGelirVergisiTutari) ldGelirVergisiTutari,sum(GV_HazineIndirimi) GV_HazineIndirimi,sum(DamgaVergisi) DamgaVergisi,sum(SGK_DevirdenKullanilmis) SGK_DevirdenKullanilmis,sum(ldSSKMatrahi) ldSSKMatrahi,sum(nSSKGun) nSSKGun,sum(SGK_PrimTutari_Isveren) SGK_PrimTutari_Isveren,sum(SGKIsverenTesvikTutari) SGKIsverenTesvikTutari,sum(SGK_PrimTutari_Isci) SGK_PrimTutari_Isci,sum(NormalGelir) NormalGelir,sum(FazlaMesaiUcreti) FazlaMesaiUcreti,sum(EkGelirToplami) EkGelirToplami,sum(BrutUcret) BrutUcret, sum(ldYasalKesintiTutari) ldYasalKesintiTutari,sum(NetUcret) NetUcret, sum(T.EkKesintiToplami) EkKesintitoplami,sum(NetOdenen) NetOdenen,sum(IndirimUcreti) IndirimUcreti from  ( SELECT 0 ldGunlukUcret,'' UcretTipi,0 ldPrsKartiAylikUcret,sum (Issiz.ldIsciHissesi) Issizlik_IsciHissesi ,sum (Issiz.ldMatrah) Issizlik_Matrah, sum (Issiz.ldIsverenHissesi) Issizlik_IsverenHissesi,sum (Issiz.ldDevletKatkiPayi) Issizlik_DevletPayi,sum (GVMtrh.ldTutar) GV_AylikMatrah,min (GVMtrh.ldBirikenGVMatrah) BirikenGVMatrahi,sum (GVMtrh.ldAsgariGecimIndirimi) GV_AGI,max (GVMtrh.ldAsgariGecimIndirimOrani) GV_AGIOrani, sum (PrsIkr.ldGelirVergisiTutari) ldGelirVergisiTutari,sum (GVMtrh.ldHazineIndirimi) GV_HazineIndirimi,sum(PrsIkr.ldDamgaVergisiTutari) DamgaVergisi ,sum (SGK.ldDevirKullanilmisMatrah) SGK_DevirdenKullanilmis,sum (SGK.ldSSKMatrahi) ldSSKMatrahi,sum(SGK.nSSKGun) nSSKGun,sum(PrsIkr.ldSSKIsverenTesvikPrimi) SGKIsverenTesvikTutari,sum(PrsIkr.ldSSkIsverenPrimi) SGK_PrimTutari_Isveren, sum(PrsIkr.ldSSKPrimiTutari) SGK_PrimTutari_Isci,0 NormalGelir,0 FazlaMesaiUcreti,sum(PrsIkr.ldEkGelirUcreti) EkGelirToplami,sum(PrsIkr.ldekGelirUcreti) BrutUcret,sum(PrsIkr.ldYasalKesintiTutari) ldYasalKesintiTutari,sum(PrsIkr.ldSonNetUcret) NetUcret, sum(PrsIkr.ldDigerKesintiler) EkKesintiToplami,sum(PrsIkr.ldOdenen) NetOdenen, 0 IndirimUcreti,PrsIkr.nYil nYil, PrsIkr.nAy nAy,PrsIkr.pPersonel,PrsIkr.pIsYeri,0 pTahakkukTanimi FROM   GUSTO00003.PersonelIkramiye PrsIkr LEFT OUTER JOIN GUSTO00003.GelirVergisiMatrahi GVMtrh ON (PrsIkr.pPersonel=GVMtrh.pPersonel AND PrsIkr.nYil=GVMtrh.nYil AND PrsIkr.nAy=GVMtrh.nAy AND PrsIkr.pIsYeri=GVMtrh.pIsyeri AND PrsIkr.pIkramiyeTanimi=GVMtrh.pIkramiyeTanimi) LEFT OUTER JOIN GUSTO00003.IssizlikSigBilgileri Issiz ON (PrsIkr.pPersonel=Issiz.pPersonel AND PrsIkr.nYil=Issiz.nYil AND PrsIkr.nAy=Issiz.nAy AND PrsIkr.pIsYeri=Issiz.pIsyeri AND PrsIkr.pIkramiyeTanimi=Issiz.pIkramiyeTanimi)LEFT OUTER JOIN GUSTO00003.SSKMatrahBilgileri SGK ON (PrsIkr.pPersonel=SGK.pPersonel AND PrsIkr.nYil=SGK.nYil AND PrsIkr.nAy=SGK.nAy AND PrsIkr.pIsYeri=SGK.pIsyeri AND PrsIkr.pIkramiyeTanimi=SGK.pIkramiyeTanimi) WHERE  Issiz.cTip='I' AND GVMtrh.cTip='I' AND SGK.cTip='I' group by PrsIkr.nYil,PrsIkr.nAy,PrsIkr.pPersonel,PrsIkr.pIsYeri  union all SELECT max(PrsMaas.ldGunlukUcret) ldGunlukUcret,max((case (PrsMaas.cUcretNetBrutTipi)  when 'B' then 'Brüt' else 'Net' end)) UcretTipi,max(PrsMaas.ldPrsKartiAylikUcret) ldPrsKartiAylikUcret,sum (Issiz.ldIsciHissesi) Issizlik_IsciHissesi ,sum (Issiz.ldMatrah) Issizlik_Matrah, sum (Issiz.ldIsverenHissesi) Issizlik_IsverenHissesi,sum (Issiz.ldDevletKatkiPayi) Issizlik_DevletPayi, sum (GVMtrh.ldTutar) GV_AylikMatrah,min (GVMtrh.ldBirikenGVMatrah) BirikenGVMatrahi,sum (GVMtrh.ldAsgariGecimIndirimi) GV_AGI,max (GVMtrh.ldAsgariGecimIndirimOrani) GV_AGIOrani, sum (PrsMaas.ldGelirVergisiTutari) ldGelirVergisiTutari,sum (GVMtrh.ldHazineIndirimi) GV_HazineIndirimi,sum(PrsMaas.ldDamgaVergisiTutari) DamgaVergisi ,sum (SGK.ldDevirKullanilmisMatrah) SGK_DevirdenKullanilmis,sum (SGK.ldSSKMatrahi) ldSSKMatrahi,sum(SGK.nSSKGun) nSSKGun,sum(PrsMaas.ldSSKIsverenTesvikPrimi) SGKIsverenTesvikTutari,sum(PrsMaas.ldSSkIsverenPrimi) SGK_PrimTutari_Isveren, sum(PrsMaas.ldSSKPrimiTutari) SGK_PrimTutari_Isci,sum(PrsMaas.ldNormalCalismaUcreti) NormalGelir, sum(PrsMaas.ldNormalFazlaMesaiUcreti + PrsMaas.ldTatilFazlaMesaiUcreti + PrsMaas.ldResmiBayramFazlaMesaiUcreti+PrsMaas.ldDiniBayramFazlaMesaiUcreti ) FazlaMesaiUcreti,sum(PrsMaas.ldTumEkGelirlerToplami) EkGelirToplami,sum(PrsMaas.ldBrutUcret) BrutUcret,sum(PrsMaas.ldYasalKesintiTutari) ldYasalKesintiTutari,sum(PrsMaas.ldNetUcret) NetUcret,sum(PrsMaas.ldDigerKesintiler) EkKesintiToplami,sum(PrsMaas.ldOdenen) NetOdenen,sum(PrsMaas.ldIndirimUcretiToplami) IndirimUcreti,PrsMaas.nYil nYil, PrsMaas.nAy nAy,PrsMaas.pPersonel,PrsMaas.pIsYeri,pTahakkukTanimi   FROM GUSTO00003.PersonelMaas PrsMaas LEFT OUTER JOIN GUSTO00003.GelirVergisiMatrahi GVMtrh ON (PrsMaas.pPersonel=GVMtrh.pPersonel AND PrsMaas.nYil=GVMtrh.nYil AND PrsMaas.nAy=GVMtrh.nAy AND PrsMaas.pIsYeri=GVMtrh.pIsyeri AND PrsMaas.pTahakkukTanimi=GVMtrh.pIkramiyeTanimi) LEFT OUTER JOIN GUSTO00003.IssizlikSigBilgileri Issiz ON (PrsMaas.pPersonel=Issiz.pPersonel AND PrsMaas.nYil=Issiz.nYil AND PrsMaas.nAy=Issiz.nAy AND PrsMaas.pIsYeri=Issiz.pIsyeri AND PrsMaas.pTahakkukTanimi=Issiz.pIkramiyeTanimi) LEFT OUTER JOIN GUSTO00003.SSKMatrahBilgileri SGK ON (PrsMaas.pPersonel=SGK.pPersonel AND PrsMaas.nYil=SGK.nYil AND PrsMaas.nAy=SGK.nAy AND PrsMaas.pIsYeri=SGK.pIsyeri AND PrsMaas.pTahakkukTanimi=SGK.pIkramiyeTanimi) WHERE  Issiz.cTip='M' AND GVMtrh.cTip='M' AND SGK.cTip='M' group by PrsMaas.nYil,PrsMaas.nAy,PrsMaas.pPersonel,PrsMaas.pIsYeri,PrsMaas.pTahakkukTanimi ) T group by nYil,nAy,pPersonel,pIsYeri,pTahakkukTanimi 
GO